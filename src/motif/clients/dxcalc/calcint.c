/*
 * *****************************************************************
 * *                                                               *
 * *    Copyright (c) Digital Equipment Corporation, 1991, 1994    *
 * *                                                               *
 * *   All Rights Reserved.  Unpublished rights  reserved  under   *
 * *   the copyright laws of the United States.                    *
 * *                                                               *
 * *   The software contained on this media  is  proprietary  to   *
 * *   and  embodies  the  confidential  technology  of  Digital   *
 * *   Equipment Corporation.  Possession, use,  duplication  or   *
 * *   dissemination of the software and media is authorized only  *
 * *   pursuant to a valid written license from Digital Equipment  *
 * *   Corporation.                                                *
 * *                                                               *
 * *   RESTRICTED RIGHTS LEGEND   Use, duplication, or disclosure  *
 * *   by the U.S. Government is subject to restrictions  as  set  *
 * *   forth in Subparagraph (c)(1)(ii)  of  DFARS  252.227-7013,  *
 * *   or  in  FAR 52.227-19, as applicable.                       *
 * *                                                               *
 * *****************************************************************
 */
/*
 * HISTORY
 */
#ifdef OSF1
/*
**************************************************************************
**                   DIGITAL EQUIPMENT CORPORATION                      **
**                         CONFIDENTIAL                                 **
**    NOT FOR MODIFICATION OR REDISTRIBUTION IN ANY MANNER WHATSOEVER   **
**************************************************************************
*/
#ifndef lint
static char *BuildSystemHeader =
  "$Header: /usr/sde/osf1/rcs/x11/src/motif/clients/dxcalc/calcint.c,v 1.1.7.3 1993/10/19 19:56:07 Susan_Ng Exp $";
#endif
#endif
/* Header from VMS source pool
static char *BuildSystemHeader =
  "$Header: /usr/sde/osf1/rcs/x11/src/motif/clients/dxcalc/calcint.c,v 1.1.7.3 1993/10/19 19:56:07 Susan_Ng Exp $";
*/
/*
**++

  Copyright (c) Digital Equipment Corporation,
  1987, 1988, 1989, 1990, 1991, 1992
  All Rights Reserved.  Unpublished rights reserved
  under the copyright laws of the United States.

  The software contained on this media is proprietary
  to and embodies the confidential technology of
  Digital Equipment Corporation.  Possession, use,
  duplication or dissemination of the software and
  media is authorized only pursuant to a valid written
  license from Digital Equipment Corporation.

  RESTRICTED RIGHTS LEGEND   Use, duplication, or
  disclosure by the U.S. Government is subject to
  restrictions as set forth in Subparagraph (c)(1)(ii)
  of DFARS 252.227-7013, or in FAR 52.227-19, as
  applicable.

**--
**/
/*
**++
**  MODULE NAME:
**	calcint.c
**
**  FACILITY:
**      OOTB Calculator
**
**  ABSTRACT:
**	This sample main module just creates an instance
**	of the Calc widget.
**
**  AUTHORS:
**      Dennis McEvoy, Neal Finnegan
**
**  RELEASER:
**
**  CREATION DATE:     6-OCT-1987
**
**  MODIFICATION HISTORY:
**
**    Version:
**
**	Nov 1990 - V3.0 	(ASP) - Motif conversion and added memex support.
**      May 1992 - V3.1         (SP)  - I18N and maintenance changes.
**--
**/

#include "calcdefs.h"
#include "calc.h"

#if defined(VMS) && !defined(__DECC)
#pragma nostandard
#endif

#include <X11/DECWmHints.h>

#if (((XmVERSION == 1) && (XmREVISION >= 2)) || XmVERSION >= 2)
#include <Xm/RepType.h>
#endif

#if defined(VMS) && !defined(__DECC)
#pragma standard
#endif

/* routines used for supporting multiple size icon. */
static void set_icons_on_shell();
Pixmap fetch_bitmap_icon();
static char *get_icon_index_name();
static void set_iconify_pixmap();
void set_icons();

extern DwtMyCalcCreate();

XtAppContext app_context;
Widget toplevel;
CalcWidget top_wid;

external CalcWidgetClass calcwidgetclass;

static char CALCULATOR_75_bits[] = {
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0xaa,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xab, 0xaa, 0xff, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0xd5,
   0x55, 0x54, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x2a, 0xa8,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0xd5, 0x55, 0x54, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x2a, 0xa8, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0x02, 0x55, 0xd5, 0x55, 0x54, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xab, 0xaa, 0x2a, 0xa8, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0xd5,
   0x55, 0x54, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x2a, 0xa8,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0xd5, 0xff, 0x55, 0xff, 0x55, 0xff,
   0xff, 0xff, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
   0xa8, 0x02, 0xd5, 0x55, 0x55, 0x55, 0x54, 0x57, 0x55, 0x55, 0x51, 0x01,
   0xab, 0xaa, 0xaa, 0xaa, 0xa8, 0xaa, 0xaa, 0xaa, 0xa0, 0x02, 0xd5, 0x55,
   0x55, 0x55, 0x50, 0x57, 0x55, 0x55, 0x51, 0x01, 0xab, 0xaa, 0xaa, 0xaa,
   0xa8, 0xaa, 0xaa, 0xaa, 0xa0, 0x02, 0xd5, 0x55, 0x55, 0x55, 0x50, 0x57,
   0x55, 0x55, 0x51, 0x01, 0xab, 0x00, 0x2a, 0x00, 0xa8, 0x00, 0x00, 0x00,
   0xa0, 0x02, 0x55, 0x01, 0x55, 0x00, 0x50, 0x01, 0x00, 0x00, 0x50, 0x01,
   0xab, 0x82, 0x2a, 0x00, 0xa8, 0x02, 0x00, 0x00, 0xa0, 0x02, 0x55, 0xd5,
   0x55, 0x54, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x2a, 0xa8,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0xd5, 0x55, 0x54, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x2a, 0xa8, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0x02, 0x55, 0xd5, 0x55, 0x54, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xab, 0xaa, 0x2a, 0xa8, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0xd5,
   0x55, 0x54, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x00, 0xa8,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x00, 0x54, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0x00, 0xa8, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0xaa,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55,
   0x57, 0x55, 0xf5, 0x5f, 0x55, 0xfd, 0x7f, 0x01, 0xab, 0xaa, 0xab, 0xaa,
   0xaa, 0x2a, 0xa8, 0xae, 0x8a, 0x02, 0x55, 0xd5, 0x55, 0x55, 0x55, 0x55,
   0x50, 0x57, 0x05, 0x01, 0xab, 0xea, 0xaa, 0xaa, 0xaa, 0xaa, 0xa0, 0xab,
   0x82, 0x02, 0x55, 0x55, 0x15, 0x55, 0x55, 0x55, 0xc1, 0x55, 0x41, 0x01,
   0xab, 0xaa, 0x0a, 0xaa, 0xaa, 0xaa, 0xe2, 0xaa, 0xa0, 0x02, 0x55, 0x55,
   0x05, 0x55, 0x55, 0x55, 0x75, 0x55, 0x50, 0x01, 0xab, 0xaa, 0x82, 0xaa,
   0xaa, 0xaa, 0xaa, 0x2a, 0xa8, 0x02, 0xd5, 0xff, 0xff, 0x7f, 0x55, 0x55,
   0x55, 0x15, 0x54, 0x01, 0xab, 0xaa, 0xaa, 0x2a, 0xaa, 0xaa, 0xaa, 0x0a,
   0xaa, 0x02, 0xd5, 0x55, 0x55, 0x55, 0x54, 0x55, 0x55, 0x05, 0x55, 0x01,
   0xab, 0xaa, 0xaa, 0x2a, 0xa8, 0xaa, 0xaa, 0x82, 0xaa, 0x02, 0xd5, 0x55,
   0x55, 0x55, 0x54, 0xd5, 0x55, 0x41, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0x2a,
   0xa8, 0xea, 0xaa, 0x82, 0xaa, 0x02, 0xd5, 0x55, 0x55, 0x55, 0x54, 0x75,
   0x55, 0x05, 0x55, 0x01, 0x2b, 0x00, 0x00, 0x00, 0xa8, 0xba, 0xaa, 0x0a,
   0xaa, 0x02, 0x55, 0x00, 0x00, 0x00, 0x54, 0x5d, 0x55, 0x15, 0x54, 0x01,
   0xab, 0x00, 0x00, 0x00, 0xa8, 0xae, 0x8a, 0x2a, 0xa8, 0x02, 0x55, 0x55,
   0x57, 0x55, 0x55, 0x57, 0x05, 0x55, 0x50, 0x01, 0xab, 0xaa, 0xab, 0xaa,
   0xaa, 0xab, 0x82, 0xaa, 0xa0, 0x02, 0x55, 0xd5, 0x55, 0x55, 0xd5, 0x55,
   0x41, 0x55, 0x41, 0x01, 0xab, 0xea, 0xaa, 0xaa, 0xea, 0xaa, 0xa0, 0xaa,
   0x82, 0x02, 0x55, 0x55, 0x15, 0x55, 0x75, 0x55, 0x50, 0x55, 0x05, 0x01,
   0xab, 0xaa, 0x0a, 0xaa, 0x2a, 0x00, 0xa8, 0x0a, 0x00, 0x02, 0x55, 0x55,
   0x05, 0x55, 0x55, 0x00, 0x54, 0x15, 0x00, 0x01, 0xab, 0xaa, 0x82, 0xaa,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x45, 0x55, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55,
   0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0x03, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

static char CALCULATOR_50_bits[] = {
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55,
   0x55, 0x01, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x7d, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xaa, 0x2a, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55,
   0x5d, 0x54, 0x55, 0x55, 0x55, 0x01, 0xaa, 0x2a, 0xa8, 0xaa, 0xaa, 0xaa,
   0x02, 0x55, 0x5d, 0x54, 0x55, 0x55, 0x55, 0x01, 0xaa, 0x2a, 0xa8, 0xaa,
   0xaa, 0xaa, 0x02, 0xf5, 0xd7, 0x5f, 0xfd, 0xff, 0x57, 0x01, 0xaa, 0xaa,
   0x8a, 0xaa, 0xaa, 0xa2, 0x02, 0x55, 0x55, 0x15, 0x55, 0x55, 0x45, 0x01,
   0xaa, 0xaa, 0x8a, 0xaa, 0xaa, 0x82, 0x02, 0x15, 0x50, 0x00, 0x05, 0x00,
   0x40, 0x01, 0x2a, 0x28, 0x80, 0x0a, 0x00, 0x80, 0x02, 0x55, 0x5c, 0x00,
   0x15, 0x00, 0x40, 0x01, 0xaa, 0x2a, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55,
   0x5d, 0x54, 0x55, 0x55, 0x55, 0x01, 0xaa, 0x2a, 0xaa, 0xaa, 0xaa, 0xaa,
   0x02, 0x55, 0x5d, 0x54, 0x55, 0x55, 0x55, 0x01, 0xaa, 0x02, 0xaa, 0xaa,
   0xaa, 0xaa, 0x02, 0x55, 0x05, 0x54, 0x55, 0x55, 0x55, 0x01, 0xaa, 0x0a,
   0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55,
   0x55, 0x01, 0xaa, 0xae, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x57, 0x55,
   0x55, 0x55, 0x55, 0x01, 0xaa, 0xab, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55,
   0x55, 0x55, 0x7f, 0xf5, 0x57, 0x01, 0xaa, 0x2a, 0xaa, 0x2a, 0xa8, 0xa2,
   0x02, 0x55, 0x15, 0x54, 0x55, 0x50, 0x41, 0x01, 0xaa, 0x0a, 0xaa, 0xaa,
   0xa8, 0xa0, 0x02, 0x55, 0x05, 0x55, 0x55, 0x55, 0x50, 0x01, 0xfa, 0xff,
   0xaf, 0xaa, 0x2a, 0xa8, 0x02, 0x55, 0x55, 0x45, 0x55, 0x15, 0x54, 0x01,
   0xaa, 0xaa, 0x8a, 0xaa, 0x0a, 0xaa, 0x02, 0x05, 0x00, 0x40, 0x75, 0x15,
   0x54, 0x01, 0x0a, 0x00, 0x80, 0xba, 0x2a, 0xa8, 0x02, 0x15, 0x00, 0x00,
   0x5d, 0x55, 0x50, 0x01, 0xaa, 0xae, 0xaa, 0xae, 0xa8, 0xa0, 0x02, 0x55,
   0x57, 0x55, 0x57, 0x50, 0x41, 0x01, 0xaa, 0x2a, 0xaa, 0x2b, 0xa8, 0x82,
   0x02, 0x55, 0x15, 0x54, 0x15, 0x54, 0x05, 0x01, 0xaa, 0x0a, 0xaa, 0x00,
   0x2a, 0x00, 0x02, 0x55, 0x05, 0x55, 0x01, 0x55, 0x00, 0x01, 0xaa, 0x8a,
   0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x01,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x02, 0x55, 0x55, 0x55, 0x55, 0x55,
   0x55, 0x01};

static char CALCULATOR_32_bits[] = {
   0xaa, 0xaa, 0xaa, 0xaa, 0xd5, 0x47, 0x55, 0x55, 0xaa, 0xa2, 0xaa, 0xaa,
   0xd5, 0x45, 0x55, 0x55, 0xaa, 0xa2, 0xaa, 0xaa, 0xfd, 0x7d, 0xfd, 0x5f,
   0xaa, 0x2a, 0xaa, 0x8a, 0x5d, 0x55, 0x5c, 0x15, 0x82, 0x02, 0x02, 0x80,
   0x85, 0x05, 0x05, 0x00, 0xaa, 0xa2, 0xaa, 0xaa, 0xd5, 0x45, 0x55, 0x55,
   0xaa, 0xa0, 0xaa, 0xaa, 0x55, 0x40, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa,
   0x55, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xd5, 0x55, 0x55, 0x55,
   0xea, 0xaa, 0xaa, 0xaa, 0x55, 0x51, 0x47, 0x5f, 0xaa, 0xa8, 0x8a, 0xa3,
   0x55, 0x55, 0xd5, 0x51, 0xfe, 0xbf, 0xaa, 0xa8, 0x55, 0x55, 0x55, 0x54,
   0xae, 0x8a, 0xba, 0xa8, 0x05, 0x00, 0x5d, 0x51, 0x0a, 0x80, 0x8e, 0xa2,
   0xd5, 0x55, 0x47, 0x45, 0xea, 0xaa, 0xa3, 0x8a, 0x55, 0x51, 0x50, 0x01,
   0xaa, 0xa8, 0xaa, 0xaa, 0x55, 0x55, 0x55, 0x55};

static char CALCULATOR_17_bits[] = {
   0x00, 0x00, 0x00, 0xfe, 0xff, 0x00, 0x02, 0x80, 0x00, 0x22, 0x80, 0x00,
   0x22, 0x80, 0x00, 0xfa, 0xbe, 0x00, 0x22, 0x80, 0x00, 0x22, 0x80, 0x00,
   0x02, 0x80, 0x00, 0x22, 0xa2, 0x00, 0x02, 0x94, 0x00, 0xfa, 0x88, 0x00,
   0x02, 0x94, 0x00, 0x22, 0xa2, 0x00, 0x02, 0x80, 0x00, 0xfe, 0xff, 0x00,
   0x00, 0x00, 0x00};

/*
**++
**  ROUTINE NAME:
**	MakePixmap
**
**  FUNCTIONAL DESCRIPTION:
**	Routine to make a pixmap stolen from session mgr
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
static Pixmap MakePixmap(dpy, root, data, width, height)
    Display *dpy;
    Drawable root;
    char *data;
    Dimension width, height;
{
    Pixmap pid;
    unsigned long ScreenNumber;

    ScreenNumber = XDefaultScreen(dpy);

    pid =
      XCreatePixmapFromBitmapData(dpy, root, data, (Dimension) width,
      (Dimension) height, (unsigned long) BlackPixel(dpy, ScreenNumber),
      (unsigned long) WhitePixel(dpy, ScreenNumber), 1);

    /* The following line remove to support Motif. */
    /* (unsigned int) DefaultDepth (dpy, ScreenNumber)); */
    return (pid);
}

/*
**++
**  ROUTINE NAME:
**	main
**
**  FUNCTIONAL DESCRIPTION:
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
main(argc, argv)
    int argc;
    char **argv;
{
    int status, xtnumber;
    Arg args[8];
    Display *dpy;
    Pixmap icon_pixmap, sm_icon_pixmap;

    /* Widget unmanaged_toplevel; */

#ifdef R5_XLIB
    /* XtSetLanguageProc() should be called before XtAppInitialize() */
    XtSetLanguageProc(NULL, NULL, NULL);
#endif /* R5_XLIB */

    MrmInitialize();
    DXmInitialize();

#if (((XmVERSION == 1) && (XmREVISION >= 2)) || XmVERSION >= 2)
    XmRepTypeInstallTearOffModelConverter();
#endif

    status = MrmRegisterClass(MrmwcUnknown, "calc_widget", "DwtMyCalcCreate",
      DwtMyCalcCreate, calcwidgetclass);

    XtToolkitInitialize();

    app_context = XtCreateApplicationContext();

    dpy = XtOpenDisplay(app_context, NULL, APPL_NAME, CLASS_NAME, NULL, 0,
      &argc, argv);

    if (dpy == 0)

	/* exit with error */
	XtAppErrorMsg(app_context, "invalidDisplay", "XtOpenDisplay",
	  "XtToolkitError", "Can't Open display", (String *) NULL,
	  (Cardinal *) NULL);

    toplevel = XtAppCreateShell(APPL_NAME, CLASS_NAME,
      applicationShellWidgetClass, dpy, NULL, 0);

    top_wid = (CalcWidget) DwtMyCalc(toplevel, 
		"Calc", 
		200, 
		300, 
		175,
		210);

    XtManageChild((Widget) top_wid);


    /* Add an event handler to track Reparent notify events for the index
     * window. */
    XtAddEventHandler(toplevel, StructureNotifyMask, False, set_icons_on_shell,
      None);


    /* Set the icon pixmap by calling set_icons(). */
    set_icons(toplevel, NULL);

    /*XtRealizeWidget(toplevel, 0, NULL);*/
    XtRealizeWidget(toplevel);

    XtAppMainLoop(app_context);
}

/*
**++
**  ROUTINE NAME:
**	set_icons_on_shell
**
**  FUNCTIONAL DESCRIPTION:
**	Callback routine which sets the icon pixmaps for
**	Reparenting window managers.
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
static void set_icons_on_shell(shell, user_data, event)
    Widget shell;
    caddr_t user_data;			/* unused */
    XEvent *event;
{
    int num_sizes;
    Display *dpy = XtDisplay(shell);
    Window root_window = XDefaultRootWindow(dpy);
    XIconSize *size_list;
    XReparentEvent *reparent = (XReparentEvent *) &event->xreparent;

    if (event->type != ReparentNotify)
	return;

    /* Ignore reparents back to the root window. */
    if (reparent->parent == root_window)
	return;

    /* Set the icons for this shell. */
    if (!XGetIconSizes(dpy, root_window, &size_list, &num_sizes))
	return;
    else {
	XFree(size_list);
	set_icons(shell, NULL);
    }
}

/*
**++
**  ROUTINE NAME:
**	set_icons
**
**  FUNCTIONAL DESCRIPTION:
**	Sets the icon and iconify pixmaps for the given shell widget.
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
void set_icons(shell, hierarchy_id)
    Widget shell;
    MrmHierarchy hierarchy_id;
{
    char *icon_name;
    int ac;
    unsigned int icon_size;
    static char *shell_icon_sizes[] = {"75", "50", "32", "17"};
    static int num_sizes = XtNumber(shell_icon_sizes);
    static unsigned int current_icon_size = 0;
    static Pixmap icon_pixmap = 0, iconify_pixmap = 0;
    Arg args[5];
    Display *dpy = XtDisplay(shell);
    Screen *scr = XtScreen(shell);

    /* Determine the icon pixmap name and size to fetch. */
    icon_name = get_icon_index_name(dpy, "ICON_PIXMAP", &icon_size,
      shell_icon_sizes, num_sizes);
    if (icon_name != NULL) {
	/*  If the icon sizes are different we need to free the current ones,
	 * and re-fetch new icons. We assume that re-fetching new icons is an
	 * infrequent operation, so we don't cache the old icons. */
	if ((current_icon_size != 0)	/* Icon exists. */
	  &&(current_icon_size != icon_size))
					/* New icon needed. */
	  {
	    if (icon_pixmap)
		XFreePixmap(dpy, icon_pixmap);
	    if ((iconify_pixmap) && (iconify_pixmap != icon_pixmap))
		XFreePixmap(dpy, iconify_pixmap);
	    icon_pixmap = 0;
	    iconify_pixmap = 0;
	    current_icon_size = 0;
	}
	if (current_icon_size == 0) {
	    current_icon_size = icon_size;
	    icon_pixmap = fetch_bitmap_icon(dpy, scr, icon_size);
	}
	XtFree(icon_name);
	icon_name = NULL;
    } else
	/* Can't get icon sizes for some reason */
	return;

    /* Fetch the iconify pixmap for compatibility with the XUI window manager.
     */
    if (DXIsXUIWMRunning(shell, 0)) {
	if (icon_size == 17)		/* Don't fetch icon twice */
	    iconify_pixmap = icon_pixmap;
	else if (icon_size > 17)
	    iconify_pixmap = fetch_bitmap_icon(dpy, scr, 17);
    }

    /* Set the icon pixmap on the shell. */
    if (icon_pixmap) {
	ac = 0;
	XtSetArg(args[ac], XtNiconPixmap, icon_pixmap);
	ac++;
	XtSetArg(args[ac], XtNallowShellResize, TRUE);
	ac++;
	XtSetValues(shell, args, ac);
    }

    /* Set the iconify pixmap for the XUI window manager */
    if ((iconify_pixmap) && (XtIsRealized(shell)))
	set_iconify_pixmap(shell, iconify_pixmap);
}

/*
**++
**  ROUTINE NAME:
**	fetch_bitmap_icon
**
**  FUNCTIONAL DESCRIPTION:
**	From the icon_size requested, create a pixmap from the
**	icon bitmap data corresponded to the size requested.
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
Pixmap fetch_bitmap_icon(dpy, scr, icon_size)
    Display *dpy;
    Screen *scr;
    int icon_size;
{
    int status;
    Pixmap pixmap_rtn;
    Window root = XDefaultRootWindow(dpy);

    switch (icon_size) {
	case 75:
	    pixmap_rtn =
	      MakePixmap(dpy, root, CALCULATOR_75_bits, icon_size, icon_size);
	    break;

	case 50:
	    pixmap_rtn =
	      MakePixmap(dpy, root, CALCULATOR_50_bits, icon_size, icon_size);
	    break;

	case 32:
	    pixmap_rtn =
	      MakePixmap(dpy, root, CALCULATOR_32_bits, icon_size, icon_size);
	    break;

	case 17:
	    pixmap_rtn =
	      MakePixmap(dpy, root, CALCULATOR_17_bits, icon_size, icon_size);
	    break;

    }
    return (Pixmap) pixmap_rtn;
}

/*
**++
**  ROUTINE NAME:
**	get_icon_index_name
**
**  FUNCTIONAL DESCRIPTION:
**	Finds the largest icon supported by the window manager and returns
**	a string which represents that icon in UIL.
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
static char *get_icon_index_name(dpy, root_index_name, icon_size_rtn,
  supported_icon_sizes, num_supported_sizes)
    Display *dpy;
    char *root_index_name;
    unsigned int *icon_size_rtn;
    char **supported_icon_sizes;
    int num_supported_sizes;
{
    int i, num_sizes, cursize, icon_size;
    char *icon_size_ptr, *icon_index = NULL;
    Boolean found_icon_size = False;
    XIconSize *size_list;

    *icon_size_rtn = 0;			/* Initial value */

    if (!XGetIconSizes(dpy, XDefaultRootWindow(dpy), &size_list, &num_sizes))
	return (NULL);

    /* Find the largest icon supported by the window manager. */
    cursize = 0;
    for (i = 1; i < num_sizes; i++) {
	if ((size_list[i].max_width >= size_list[cursize].max_width) &&
	  (size_list[i].max_height >= size_list[cursize].max_height))
	    cursize = i;
    }
    if ((size_list[cursize].max_width <= 0) ||
      (size_list[cursize].max_height <= 0)) {
	XFree(size_list);
	return (NULL);
    }

    /* Find the largest supported icon. */
    for (i = 0; i < num_supported_sizes; i++) {
	icon_size = atoi(supported_icon_sizes[i]);
	if ((icon_size <= size_list[cursize].max_width) &&
	  (icon_size <= size_list[cursize].max_height)) {
	    icon_size_ptr = supported_icon_sizes[i];
	    found_icon_size = TRUE;
	    break;
	}
    }
    XFree(size_list);

    /* Build the icon index name */
    /* format: root_index_name + "_" + icon_size_ptr + "X" + icon_size_ptr */
    if (found_icon_size) {
	icon_index = (char *) XtMalloc(strlen(root_index_name) + sizeof("_") +
	  (2 * sizeof(icon_size_ptr)) + 1);
					/* for \0 char */
	strcpy(icon_index, root_index_name);
	strcat(icon_index, "_");
	strcat(icon_index, icon_size_ptr);
	strcat(icon_index, "X");
	strcat(icon_index, icon_size_ptr);

	*icon_size_rtn = (unsigned int) icon_size;
    }
    return (icon_index);
}

/*
**++
**  ROUTINE NAME:
**	set_iconify_pixmap
**
**  FUNCTIONAL DESCRIPTION:
**	Sets the iconify pixmap in the DEC_WM_HINTS property for the
**	given shell widget.
**
**  FORMAL PARAMETERS:
**
**  IMPLICIT INPUTS:
**
**  IMPLICIT OUTPUTS:
**
**  FUNCTION VALUE:
**
**  SIDE EFFECTS:
**--
**/
static void set_iconify_pixmap(toplevel, iconify_pixmap)
    Widget toplevel;
    Pixmap iconify_pixmap;
{
    Pixmap		spix;
    Atom		dwm_atom;
    DECWmHintsRec	dwm_hint;
    int			status;

    /*
    ** Check for XUI.
    */
    if (!DXIsXUIWMRunning (toplevel, False)) return;

    /*
    ** Look for dxwm and do iconify pixmap if possible.
    */
    dwm_atom = XmInternAtom (XtDisplay(toplevel), "DEC_WM_HINTS", True);
    if (dwm_atom != None)
    {

	spix = iconify_pixmap;

	dwm_hint.value_mask = DECWmIconifyPixmapMask;
	dwm_hint.iconify_pixmap = spix;
	XChangeProperty
	(
	    XtDisplay(toplevel),
	    XtWindow (toplevel),
	    dwm_atom,
	    dwm_atom,
	    32,
	    PropModeReplace,
	    (unsigned char *)&dwm_hint,
	    9
	);
    }
}
